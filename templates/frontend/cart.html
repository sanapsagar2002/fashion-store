{% extends 'base.html' %}

{% block title %}Shopping Cart - Fashion Store{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="mb-4">Shopping Cart</h2>
    
    <div id="cart-content">
        <!-- Cart items will be loaded here -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadCart() {
        if (!authToken) {
            document.getElementById('cart-content').innerHTML = `
                <div class="alert alert-info">
                    <h4>Please login to view your cart</h4>
                    <p>You need to be logged in to view and manage your cart items.</p>
                    <a href="/login/" class="btn btn-primary">Login</a>
                </div>
            `;
            return;
        }

        try {
            const response = await apiRequest('/api/cart/');
            const cart = await response.json();
            
            displayCart(cart);
        } catch (error) {
            console.error('Error loading cart:', error);
            document.getElementById('cart-content').innerHTML = `
                <div class="alert alert-danger">Error loading cart</div>
            `;
        }
    }

    function displayCart(cart) {
        const container = document.getElementById('cart-content');
        
        if (!cart.items || cart.items.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info text-center">
                    <h4>Your cart is empty</h4>
                    <p>Start shopping to add items to your cart!</p>
                    <a href="/products/" class="btn btn-primary">Continue Shopping</a>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            ${cart.items.map(item => `
                                <div class="row align-items-center border-bottom py-3" id="cart-item-${item.id}">
                                    <div class="col-md-2">
                                        <img src="https://via.placeholder.com/100x100" class="img-fluid" alt="${item.product_variant.product.name}">
                                    </div>
                                    <div class="col-md-4">
                                        <h6>${item.product_variant.product.name}</h6>
                                        <p class="text-muted mb-1">Size: ${item.product_variant.size}</p>
                                        <p class="text-muted mb-0">Color: ${item.product_variant.color}</p>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="input-group">
                                            <button class="btn btn-outline-secondary btn-sm" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                            <input type="number" class="form-control form-control-sm text-center" 
                                                   value="${item.quantity}" min="1" 
                                                   onchange="updateQuantity(${item.id}, this.value)">
                                            <button class="btn btn-outline-secondary btn-sm" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <span class="fw-bold">$${item.total_price}</span>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-danger btn-sm" onclick="removeItem(${item.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>Order Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span>$${cart.total_price}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Shipping:</span>
                                <span>$${cart.total_price >= 100 ? '0.00' : '10.00'}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Tax:</span>
                                <span>$${(cart.total_price * 0.08).toFixed(2)}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold">
                                <span>Total:</span>
                                <span>$${(cart.total_price + (cart.total_price >= 100 ? 0 : 10) + (cart.total_price * 0.08)).toFixed(2)}</span>
                            </div>
                            <div class="mt-3">
                                <a href="/checkout/" class="btn btn-primary w-100">Proceed to Checkout</a>
                            </div>
                            <div class="mt-2">
                                <a href="/products/" class="btn btn-outline-secondary w-100">Continue Shopping</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) {
            removeItem(itemId);
            return;
        }

        try {
            const response = await apiRequest(`/api/cart/items/${itemId}/`, {
                method: 'PUT',
                body: JSON.stringify({ quantity: newQuantity })
            });

            if (response.ok) {
                loadCart();
                updateCartBadge();
            } else {
                showAlert('Failed to update quantity', 'danger');
            }
        } catch (error) {
            console.error('Error updating quantity:', error);
            showAlert('Error updating quantity', 'danger');
        }
    }

    async function removeItem(itemId) {
        if (!confirm('Are you sure you want to remove this item from your cart?')) {
            return;
        }

        try {
            const response = await apiRequest(`/api/cart/items/${itemId}/remove/`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadCart();
                updateCartBadge();
                showAlert('Item removed from cart', 'success');
            } else {
                showAlert('Failed to remove item', 'danger');
            }
        } catch (error) {
            console.error('Error removing item:', error);
            showAlert('Error removing item', 'danger');
        }
    }

    async function clearCart() {
        if (!confirm('Are you sure you want to clear your entire cart?')) {
            return;
        }

        try {
            const response = await apiRequest('/api/cart/clear/', {
                method: 'DELETE'
            });

            if (response.ok) {
                loadCart();
                updateCartBadge();
                showAlert('Cart cleared', 'success');
            } else {
                showAlert('Failed to clear cart', 'danger');
            }
        } catch (error) {
            console.error('Error clearing cart:', error);
            showAlert('Error clearing cart', 'danger');
        }
    }

    // Load cart on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadCart();
    });
</script>
{% endblock %}
